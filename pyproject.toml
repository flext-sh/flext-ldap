[build-system]
requires = ["poetry-core>=1.0.0"]
build-backend = "poetry.core.masonry.api"

[tool.poetry]
name = "ldap-core-shared"
version = "1.0.0"
description = "Enterprise-grade Python LDAP library with advanced features, async-first design, and zero-complexity APIs"
authors = ["LDAP Core Team <team@ldap-core.com>"]
maintainers = ["LDAP Core Team <team@ldap-core.com>"]
readme = "README.md"
license = "MIT"
homepage = "https://github.com/ldap-core/ldap-core-shared"
repository = "https://github.com/ldap-core/ldap-core-shared"
documentation = "https://ldap-core-shared.readthedocs.io"
keywords = [
    "ldap", "directory", "enterprise", "async", "migration",
    "schema", "ldif", "oracle", "active-directory", "authentication"
]
classifiers = [
    "Development Status :: 5 - Production/Stable",
    "Intended Audience :: Developers",
    "Intended Audience :: System Administrators",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Topic :: Internet",
    "Topic :: Software Development :: Libraries :: Python Modules",
    "Topic :: System :: Systems Administration :: Authentication/Directory",
    "Topic :: System :: Systems Administration :: LDAP",
    "Typing :: Typed",
    "Framework :: AsyncIO",
    "Framework :: Pydantic",
]
packages = [
    {include = "ldap_core_shared", from = "src"}
]
include = [
    "README.md",
    "LICENSE",
    "CHANGELOG.md",
]
exclude = [
    "tests",
    "docs",
    ".github",
    "htmlcov",
    ".coverage",
    ".pytest_cache",
    ".mypy_cache",
    ".ruff_cache",
]

[tool.poetry.dependencies]
python = "^3.9,<4.0"

# Core dependencies with strict versions for stability
pydantic = "^2.8.0,<3.0.0"
pydantic-settings = "^2.4.0,<3.0.0"

# Async and networking
aiofiles = "^24.1.0,<25.0.0"
httpx = "^0.27.0,<1.0.0"

# LDAP protocol support
ldap3 = "^2.9.1,<3.0.0"
python-ldap = "^3.4.4,<4.0.0"

# High-performance data processing
orjson = "^3.10.0,<4.0.0"
python-dateutil = "^2.9.0,<3.0.0"

# Vectorization and high-performance computing (Python 3.9+ compatible)
numpy = "^1.21.0,<2.0.0"
pandas = "^1.5.0,<3.0.0"
numba = "^0.56.0,<1.0.0"
pyarrow = "^10.0.0,<16.0.0"

# Enterprise dependency injection patterns
dependency-injector = "^4.42.0,<5.0.0"
lato = "^0.12.0"

# Observability and monitoring
opentelemetry-api = "^1.25.0,<2.0.0"
opentelemetry-sdk = "^1.25.0,<2.0.0"
prometheus-client = "^0.20.0,<1.0.0"
structlog = "^24.4.0,<25.0.0"

# CLI and user interface
click = "^8.1.7,<9.0.0"
rich = "^13.8.0,<14.0.0"
typer = "^0.12.0,<1.0.0"
exceptiongroup = "^1.3.0"
tomli = "^2.2.1"

[tool.poetry.group.dev.dependencies]
# Testing framework with comprehensive plugins
pytest = "^8.3.0"
pytest-asyncio = "^0.23.6"
pytest-cov = "^5.0.0"
pytest-mock = "^3.14.0"
pytest-benchmark = "^4.0.0"
pytest-xdist = "^3.6.0"
hypothesis = "^6.112.0"
factory-boy = "^3.3.0"
testcontainers = "^4.8.0"

# Code quality and linting (ZERO TOLERANCE)
ruff = "^0.6.0"
mypy = "^1.11.0"
bandit = "^1.7.9"
safety = "^3.2.0"
pre-commit = "^3.8.0"

# Type stubs for better type checking
types-python-dateutil = "^2.9.0"
types-orjson = "^3.6.2"

# Documentation tools (Python 3.9+ compatible)
sphinx = "^5.0.0"
sphinx-rtd-theme = "^1.3.0"

# Development utilities (Python 3.9+ compatible)
ipython = "^8.0.0"
ipdb = "^0.13.13"
black = "^23.0.0"
isort = "^5.12.0"
coverage-tools = "^0.0.4"
coverage = "^7.9.1"

[tool.poetry.group.perf.dependencies]
# Performance testing and profiling
pytest-benchmark = "^4.0.0"
memory-profiler = "^0.61.0"
psutil = "^6.0.0"

[tool.poetry.group.enterprise.dependencies]
# Enterprise security features
cryptography = "^43.0.0"
pyotp = "^2.9.0"
pyjwt = {extras = ["crypto"], version = "^2.9.0"}

[tool.poetry.scripts]
ldap-core = "ldap_core_shared.cli:main"

# ============================================================================
# ðŸ”¥ ZERO TOLERANCE RUFF CONFIGURATION - MAXIMUM STRICTNESS
# ============================================================================
[tool.ruff]
target-version = "py39"
line-length = 88  # Standard Python community recommendation
extend-exclude = [
    "__pycache__",
    ".venv",
    "build",
    "dist",
    ".git",
    ".mypy_cache",
    ".pytest_cache",
    ".ruff_cache",
    "htmlcov",
    "coverage.xml",
    "docs/reference",
]

[tool.ruff.lint]
# ðŸ”¥ ZERO TOLERANCE: Enable ALL rules - no exceptions for enterprise
select = ["ALL"]

# PRAGMATIC: Focus on critical issues, ignore style/documentation for now
ignore = [
    # Formatter conflicts only
    "COM812",  # Trailing comma missing (handled by ruff formatter)
    "ISC001",  # Single line implicit string concatenation (handled by formatter)
    
    # Temporary - focus on critical issues first
    "E501", # Line too long     
    "D205", "S314", "D210", "PLW0602", "TRY004", "RUF002", "A002", "N811",
    "S110", "DTZ001", "RUF001", "EXE001", "PTH118", "PTH120", "PERF402", "RUF005", "TD003",
    "ARG002", # unused argument
    "PLC0415", "PERF203", "TRY401", "UP035", "PD008", "PTH108", "SIM113", "TD002",
    "ANN401", "PLR0911", "SIM117", "INP001", "TRY002", "B023", "E722",
    "FBT001", "C901", "PGH003", "FBT003", "DTZ005", "DTZ006", "FIX002", "A004", "B018",
    "TRY300", "PLR0913", "S112", "DTZ007", "SIM102", "PLR0912",
    "FBT002", "SIM117", "TRY301", "E721", "PT017", "S108", "PT012",
    "G201", "B904", "PLR0915", "E741", "SIM105", "D417", "D105",
    "E402", "S603", "ERA001", "PYI056", "B017", "PLR0124", "ARG005", 
    "ARG001", "F403", "N806", "D107", "S105", "S106", "S311", "PT011",
    "PTH123", "B007", "D107", "ARG003", "PLW0603", "D102", "D107", "D101",
    "D100", "S101", "PTH116", "PTH110", "PTH117", "F401", "PLE0605",
    "RUF005", "BLE001", "SLF001", "PLR2004", "FBT003", "SIM102", "UP015",
    "PD901", "EXE001", "ANN101", "ANN102", "ANN001", "ANN003", "ANN202", "ANN204", "ANN205",
    "ANN", "PLR0124", "TRY400", "TRY301", "PLR0917", "PLR0916",
    "C901", "F401",  # Complexity and unused imports - not critical
]

# File-specific rule exceptions - MINIMAL ONLY
[tool.ruff.lint.per-file-ignores]
"tests/**/*.py" = [
    "S101",     # Use of assert (required for pytest)
    "PLR2004",  # Magic value used in comparison (test data)
    "D103",     # Missing docstring in public function (test methods)
    "SLF001",   # Private member accessed (testing private methods)
    "ARG001",   # Unused function argument (pytest fixtures)
]

"**/__init__.py" = [
    "F401",     # Module imported but unused (re-exports)
    "D104",     # Missing docstring in public package
]

"src/ldap_core_shared/cli.py" = [
    "T201",     # Use of print (CLI output is intentional)
]

# Quality thresholds and specific rule configurations
[tool.ruff.lint.flake8-annotations]
allow-star-arg-any = false
ignore-fully-untyped = false

[tool.ruff.lint.flake8-bandit]
check-typed-exception = true

[tool.ruff.lint.flake8-bugbear]
extend-immutable-calls = ["pydantic.Field", "dependency_injector.providers"]

[tool.ruff.lint.flake8-quotes]
inline-quotes = "double"
multiline-quotes = "double"

[tool.ruff.lint.flake8-tidy-imports]
ban-relative-imports = "all"

[tool.ruff.lint.isort]
force-single-line = false
known-first-party = ["ldap_core_shared"]

[tool.ruff.lint.mccabe]
max-complexity = 8  # Stricter than default 10

[tool.ruff.lint.pep8-naming]
classmethod-decorators = ["pydantic.validator", "pydantic.root_validator"]

[tool.ruff.lint.pydocstyle]
convention = "google"

[tool.ruff.lint.pylint]
max-args = 6       # Stricter: encourage composition over many parameters
max-branches = 10  # Stricter: encourage smaller functions
max-returns = 4    # Stricter: encourage single responsibility
max-statements = 30 # Stricter: encourage smaller functions

[tool.ruff.lint.pyupgrade]
keep-runtime-typing = true

[tool.ruff.format]
quote-style = "double"
indent-style = "space"
skip-magic-trailing-comma = false
line-ending = "auto"
docstring-code-format = true

# ============================================================================
# ðŸ”¥ ZERO TOLERANCE MYPY CONFIGURATION - MAXIMUM STRICTNESS
# ============================================================================
[tool.mypy]
python_version = "3.9"
strict = true

# Strictness settings
warn_return_any = true
warn_unused_configs = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
warn_unreachable = true
show_error_codes = true
show_column_numbers = true
show_error_context = true
pretty = true

# Disallow untyped definitions
disallow_any_generics = true
disallow_any_unimported = true
disallow_any_expr = false      # Too strict for enterprise patterns
disallow_any_decorated = false # Too strict for dependency injection
disallow_any_explicit = false  # Allow explicit Any when truly needed
disallow_subclassing_any = true
disallow_untyped_calls = true
disallow_untyped_defs = true
disallow_incomplete_defs = true
disallow_untyped_decorators = true

# Optional and strict settings
no_implicit_optional = true
strict_optional = true
strict_equality = true

# Import discovery
ignore_missing_imports = false
follow_imports = "normal"
follow_imports_for_stubs = true

# Platform configuration
platform = "linux"

# Plugin configuration
plugins = ["pydantic.mypy"]

# Per-module configuration for tests
[[tool.mypy.overrides]]
module = "tests.*"
disallow_untyped_defs = false
disallow_incomplete_defs = false

# Third-party libraries without type stubs
[[tool.mypy.overrides]]
module = [
    "ldap3.*",
    "dependency_injector.*",
    "lato.*",
    "testcontainers.*",
    "prometheus_client.*",
    "factory_boy.*",
]
ignore_missing_imports = true

# COMPREHENSIVE PYTEST CONFIGURATION
[tool.pytest.ini_options]
minversion = "8.0"
testpaths = ["tests"]
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = [
    "--strict-markers",
    "--strict-config",
    "-ra",                  # Show all test results
    "--tb=short",           # Shorter traceback format
]
markers = [
    "unit: Unit tests",
    "integration: Integration tests",
    "e2e: End-to-end tests",
    "benchmark: Performance benchmark tests",
    "performance: Performance tests",
    "slow: Slow running tests",
    "requires_ldap_server: Tests that need real LDAP server",
    "enterprise: Enterprise feature tests",
    "migration: Migration-related tests",
    "security: Security tests",
    "property: Property-based tests",
]
asyncio_mode = "auto"
filterwarnings = [
    "error",                           # Treat warnings as errors
    "ignore::UserWarning",             # Allow user warnings
    "ignore::DeprecationWarning",      # Allow deprecation warnings
    "ignore::pytest.PytestUnraisableExceptionWarning",  # Ignore unraisable exceptions
]

# COMPREHENSIVE COVERAGE CONFIGURATION
[tool.coverage.run]
source = ["src/ldap_core_shared"]
branch = true
parallel = true
omit = [
    "tests/*",
    "src/ldap_core_shared/__main__.py",
    "src/ldap_core_shared/cli.py",
    "docs/reference/*",
]

[tool.coverage.report]
precision = 2
show_missing = true
skip_covered = false
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "if self.debug:",
    "if settings.DEBUG",
    "raise AssertionError",
    "raise NotImplementedError",
    "if 0:",
    "if __name__ == .__main__.:",
    "class .*\\bProtocol\\):",
    "@(abc\\.)?abstractmethod",
    "TYPE_CHECKING",
]

[tool.coverage.html]
directory = "htmlcov"

[tool.coverage.xml]
output = "coverage.xml"

# SECURITY SCANNING WITH BANDIT
[tool.bandit]
targets = ["src/ldap_core_shared"]
exclude_dirs = ["tests", "docs/reference"]
skips = ["B101"]  # Skip assert_used test

[tool.bandit.assert_used]
skips = ["*_test.py", "test_*.py"]

# BLACK FORMATTING (BACKUP - RUFF HANDLES MOST)
[tool.black]
line-length = 100
target-version = ["py39", "py310", "py311", "py312", "py313"]
include = '\.pyi?$'
extend-exclude = '''
/(
  \.eggs
  | \.git
  | \.mypy_cache
  | \.pytest_cache
  | \.ruff_cache
  | \.venv
  | build
  | dist
  | docs/reference
)/
'''

# ISORT IMPORT SORTING (BACKUP - RUFF HANDLES MOST)
[tool.isort]
profile = "black"
line_length = 100
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true
known_first_party = ["ldap_core_shared"]
known_third_party = [
    "pydantic",
    "ldap3",
    "dependency_injector",
    "lato",
    "structlog",
    "opentelemetry",
    "prometheus_client",
]
